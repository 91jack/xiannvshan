<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title>地图搜索</title>
  <link rel="stylesheet" href="static/css/common.css">
  <link rel="stylesheet" type="text/css" href="static/css/swiper-4.3.3.min.css"/>
  <link rel="stylesheet" href="static/css/app.css">
  <link rel="stylesheet" type="text/css" href="static/css/map.css"/>
</head>
<body>
	<div class="mask"></div>
	<!--搜索-->
	<div class="top-search clearfix">
		<div class="container">
			<input type="text" placeholder="搜索感兴趣内容"/>
			<img src="static/images/icon_search.png"/>
			<a href="javascript:;" onclick="searchFn()">搜索</a>
		</div>
	</div>
	
	<div class="wrapper" id="demo05">
    <div class="scroller">
        <ul class="clearfix">
            <li class="cur" ac-id="1"><a href="javascript:void(0)">特色美食</a></li>
            <li ac-id="2"><a href="javascript:void(0)">康养医疗</a></li>
            <li ac-id="3"><a href="javascript:void(0)">酒店民宿</a></li>
            <li ac-id="4"><a href="javascript:void(0)">出行规划</a></li>
            <li ac-id="5"><a href="javascript:void(0)">风景名胜</a></li>
            <li ac-id="6"><a href="javascript:void(0)">农业基地</a></li>
            <li ac-id="7"><a href="javascript:void(0)">公共服务</a></li>
        </ul>
    </div>
</div>
	
	<div id="map"></div>
	
	<!--<div class="banner-wrap">
		<a href="">
			<img src="static/images/banner1.png"/>
		</a>
		
	</div>-->
	
	<div class="search-result">
		<ul>
			<!--特色美食-->
			<!--<li class="minsu">
				<div class="left">
					<h3> 
						<span>营业</span>
						<img src="static/mapicon/icon_dang.png" alt="" />
						鸿运酒店
					</h3>
					
					<p>1.7公里|重庆市武隆区赵家乡113号</p>
					<p>营业时间：9:00-17:00</p>
					<p>房间优惠：9.8折</p>
				</div>
				<div class="right">
					<a href="">
						<img src="static/img/icon_go.png"/>
					</a>
				</div>
			</li>-->
			
			<!--酒店民俗-->
			<!--<li class="minsu">
				<div class="left">
					<h3> 
						<span>营业</span>
						<img src="static/mapicon/icon_dang.png" alt="" />
						鸿运酒店
					</h3>
					
					<p>1.7公里|重庆市武隆区赵家乡113号</p>
					<p>营业时间：9:00-17:00</p>
					<p>
						<span>餐位数：<em>225 人</em></span>
						<span>人均消费：<em>￥45/人</em> </span>
					</p>
					<p>房间优惠：9.8折</p>
				</div>
				<div class="right">
					<a href="">
						<img src="static/img/icon_go.png"/>
					</a>
				</div>
			</li>-->
			
			<!--出行路线-->
			<!--<li class="minsu">
				<div class="left">
					<h3> 
						<span>营业</span>
						<img src="static/mapicon/icon_dang.png" alt="" />
						鸿运酒店
					</h3>
					
					<p>1.7公里|重庆市武隆区赵家乡113号</p>
					<p>营业时间：9:00-17:00</p>
					<p>
						<span>餐位数：<em>225 人</em></span>
						<span>人均消费：<em>￥45/人</em> </span>
					</p>
					<p>房间优惠：9.8折</p>
				</div>
				<div class="right">
					<a href="">
						<img src="static/img/icon_go.png"/>
					</a>
				</div>
			</li>-->
			
			
			
			
			
			
			<!--<li>
				<div class="left">
					<h3>鸿运酒店</h3>
					<p>1.7公里|重庆市武隆区赵家乡113号</p>
					<p>营业时间：9:00-17:00</p>
					<p>房间优惠：9.8折</p>
				</div>
				<div class="right">
					<img src="static/img/icon_go.png"/>
				</div>
			</li>-->
			
		</ul>
	</div>
	
<script src="static/js/jquery-3.1.1.min.js"></script>
<script src="static/js/common.js"></script>
<script src="static/js/iscroll.min.js" type="text/javascript" charset="utf-8"></script>
<script src="static/js/navbarscroll.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=wqB7npvF7DsDGlFG2oYhih93K5iEqsou"></script>
<script type="text/javascript">
// 地图高度
var clientHeight = window.screen.height;
$('#map').css('height',clientHeight-160 + 'px');
	
// 地图初始化
var map = new BMap.Map("map"); // 创建Map实例
var point = new BMap.Point(106.662101,29.501584);//赵家乡政府
map.centerAndZoom(point, 10); // 初始化地图,设置中心点坐标和地图级别
map.enableScrollWheelZoom(true); // 缩放地图


// 添加带有定位的导航控件
var navigationControl = new BMap.NavigationControl({
		// 靠左上角位置
		anchor: BMAP_ANCHOR_TOP_LEFT,
		// LARGE类型
		type: BMAP_NAVIGATION_CONTROL_LARGE,
		// 启用显示定位
    enableGeolocation: true
});

map.addControl(navigationControl);
  
// 添加定位控件
var geolocationControl = new BMap.GeolocationControl();
geolocationControl.addEventListener("locationSuccess", function(e){
	
		// 定位成功事件
		var address = '';
		address += e.addressComponent.province;
		address += e.addressComponent.city;
		address += e.addressComponent.district;
		address += e.addressComponent.street;
		address += e.addressComponent.streetNumber;
		alert("当前定位地址为：" + address);
		
		
		var geoc = new BMap.Geocoder();
		geoc.getLocation(e.point, function(rs) {
			console.log(e.point)
			// 创建定位点图标
			var positionIcon = new BMap.Icon("static/mapicon/icon_position.png", new BMap.Size(18,33));
			var positionMarker = new BMap.Marker(e.point,{icon:positionIcon});  // 创建标注
			positionMarker.addEventListener('click',attribute);
			map.addOverlay(positionMarker); 
			positionMarker.enableDragging();//可拖拽
			
			function attribute(){
				var p = positionMarker.getPosition(); // 获取marker的位置
				console.log(p);
				console.log(p.lng,p.lat);
				
				geoc.getLocation(p,function(rs){
					console.log(rs)
					var addComp = rs.addressComponents;
					var newaddress = '';
					newaddress += addComp.street;
					newaddress += addComp.streetNumber;
					console.log(newaddress);
				});
			}

		})
});

geolocationControl.addEventListener("locationError",function(e){
// 定位失败事件
    alert(e.message);
});
map.addControl(geolocationControl);
	

	
	
	
	
	
	
	
	
	
$('#demo05').navbarscroll({
	defaultSelect:0,
	endClickScroll:function(obj){
	    console.log(obj.text())
	    console.log(obj.attr('ac-id'))
	    var ac_id = obj.attr('ac-id');
	    
	    var icon = ''; 
	    if(ac_id == 1){
	    	icon = new BMap.Icon("static/mapicon/icon_meishi1.png", new BMap.Size(34,40));
	    }else if(ac_id == 2){
	    	icon = new BMap.Icon("static/mapicon/icon_yiliao1.png", new BMap.Size(40,48));
	    }else if(ac_id == 3){
	    	icon = new BMap.Icon("static/mapicon/icon_minsu1.png", new BMap.Size(34,40));
	    }else if(ac_id == 4){
	    	icon = new BMap.Icon("static/mapicon/icon_chuxing1.png", new BMap.Size(34,40));
	    }else if(ac_id == 5){
	    	icon = new BMap.Icon("static/mapicon/icon_jingqu1.png", new BMap.Size(34,40));
	    }else if(ac_id == 6){
	    	icon = new BMap.Icon("static/mapicon/icon_nongye1.png", new BMap.Size(34,40));
	    }else if(ac_id == 7){
	    	icon = new BMap.Icon("static/mapicon/icon_fuwu1.png", new BMap.Size(34,40));
	    }
	    
	    map.clearOverlays();
	    
	    getData(ac_id,icon);
	    
	}
});
	
var infoWindow = '';
// 添加标注函数
function addMarker(point,icon,label){
  var marker = new BMap.Marker(point,{icon:icon});
  map.addOverlay(marker);
  map.addOverlay(label);
  marker.addEventListener('click',function(){
  	console.log(this);
  	
  });
  
}

//var opts = {
//	width:250,
//	hieght:80,
//	offset:(50,100)
//}
	
	// 获取数据
	function getData(ac_id,icon){
		$.ajax({
				type: "get",
				url: "http://gzpswx.xnshequ.com/lvyou_api/shoplist?jsoncallback=?",
				dataType: "jsonp",
				data:{
					ac_id:ac_id,
				},
				success: function(res) {
					console.log(res.data)
					var str = '';
					for (var i = 0; i < res.data.length ; i ++) {
						// 地图标注
						var lng = res.data[i].longitude;
						var lat = res.data[i].latitude;
						console.log(lng,lat);
						var point = new BMap.Point(lng,lat);
						
						addMarker(point,icon,res.data[i].name);
						
						map.centerAndZoom(new BMap.Point(104.570896,25.798353), 14); // 初始化地图,设置中心点坐标和地图级别
						// 列表展示
						str += '<li class="minsu">'
								+	'<div class="left">'
								+		'<h3>'
									+		'<span>营业</span>'
										+'<img src="static/mapicon/icon_dang.png" alt="" />'
											+res.data[i].name
									+'	</h3>'
										
									+'	<p>1.7公里|重庆市武隆区赵家乡113号</p>'
										+'<p>营业时间：9:00-17:00</p>'
										
										+'<p>房间优惠：9.8折</p>'
									+'</div>'
									+'<div class="right">'
									+'	<a href="">'
										+	'<img src="static/img/icon_go.png"/>'
										+'</a>'
									+'</div>'
							+'	</li>'
					}
					
					//$('.search-result ul').html(str);
					
					//infoWindow = new BMap.InfoWindow(str,opts)
				}
		});
	}
	
	
	// 搜素关键字
	function searchFn(){
		var key = $('input').val()
		$.ajax({
				type: "get",
				url: "http://gzpswx.xnshequ.com/lvyou_api/shoplist?jsoncallback=?",
				dataType: "jsonp",
				data:{
					name:key
				},
				success: function(res) {
					console.log(res.data)
//					for (var i = 0; i < res.data.length ; i ++) {
//						var lng = res.data[i].longitude;
//						var lat = res.data[i].latitude;
//						console.log(lng,lat);
//						var point = new BMap.Point(lng,lat);
//						
//					
//						addMarker(point,icon);
//					}
				}
		});
	}
	
	
	
	
	
</script>
</body>
</html>